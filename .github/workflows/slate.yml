# Modified: 2026-02-06T23:00:00Z | Author: COPILOT | Change: Target self-hosted runner
# SLATE System Integration — validates tech tree, agents, dashboard, tasks

name: SLATE Integration

on:
  push:
    branches: [main, develop, 'feature/*']
    paths:
      - 'slate/**'
      - 'agents/**'
      - '.slate_tech_tree/**'
      - 'current_tasks.json'
      - 'pyproject.toml'
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: slate-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  slate-status:
    name: SLATE Status Check
    runs-on: [self-hosted, slate]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Run SLATE Status
        run: python slate/slate_status.py --quick
        continue-on-error: true

  sdk-validation:
    name: SDK Validation
    runs-on: [self-hosted, slate]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Validate SDK version sync
        run: |
          python -c "
          import tomllib
          with open('pyproject.toml', 'rb') as f:
              c = tomllib.load(f)
          toml_ver = c['project']['version']
          import slate
          sdk_ver = slate.__version__
          print(f'pyproject.toml: {toml_ver}')
          print(f'slate:          {sdk_ver}')
          assert toml_ver == sdk_ver, f'VERSION MISMATCH: {toml_ver} != {sdk_ver}'
          print('Version sync: OK')
          "

  tech-tree:
    name: Tech Tree Validation
    runs-on: [self-hosted, slate]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Validate Tech Tree JSON
        run: |
          python -c "
          import json
          with open('.slate_tech_tree/tech_tree.json', 'r') as f:
              tree = json.load(f)
          nodes = tree.get('nodes', [])
          completed = sum(1 for n in nodes if n.get('status') == 'complete')
          total = len(nodes)
          progress = (completed / total * 100) if total > 0 else 0
          print(f'Tech Tree: {completed}/{total} nodes complete ({progress:.1f}%)')
          "

  dashboard:
    name: Dashboard Smoke Test
    runs-on: [self-hosted, slate]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Test Dashboard Import
        run: |
          python -c "
          try:
              from agents.slate_dashboard_server import app
              print('Dashboard module imports successfully')
          except ImportError as e:
              print(f'Dashboard import failed: {e}')
              exit(1)
          "

  agents:
    name: Agent Module Test
    runs-on: [self-hosted, slate]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Test Agent Module Imports
        run: |
          python -c "
          import sys
          errors = []
          modules = [
              'slate.slate_status',
              'slate.slate_runtime',
              'slate.slate_hardware_optimizer',
              'slate.slate_benchmark',
          ]
          for mod in modules:
              try:
                  __import__(mod)
                  print(f'OK {mod}')
              except Exception as e:
                  print(f'FAIL {mod}: {e}')
                  errors.append(mod)
          if errors:
              print(f'Failed to import {len(errors)} modules')
              sys.exit(1)
          else:
              print('All agent modules import successfully')
          "

  task-queue:
    name: Task Queue Validation
    runs-on: [self-hosted, slate]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Validate Task Queue
        run: |
          python -c "
          import json
          with open('current_tasks.json', 'r') as f:
              data = json.load(f)
          tasks = data.get('tasks', data) if isinstance(data, dict) else data
          if isinstance(tasks, list):
              pending = [t for t in tasks if t.get('status') == 'pending']
              in_progress = [t for t in tasks if t.get('status') == 'in_progress']
              completed = [t for t in tasks if t.get('status') == 'completed']
              print(f'Task Queue: {len(pending)} pending, {len(in_progress)} in-progress, {len(completed)} completed')
              print(f'Total: {len(tasks)} tasks')
          else:
              print('Task queue format unexpected, skipping validation')
          "

  summary:
    name: SLATE Summary
    needs: [slate-status, sdk-validation, tech-tree, dashboard, agents, task-queue]
    runs-on: [self-hosted, slate]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## SLATE Integration Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SLATE Status | ${{ needs.slate-status.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SDK Validation | ${{ needs.sdk-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tech Tree | ${{ needs.tech-tree.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dashboard | ${{ needs.dashboard.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Agents | ${{ needs.agents.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Task Queue | ${{ needs.task-queue.result }} |" >> $GITHUB_STEP_SUMMARY
